name: Build Student Behavior App

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Python packages
      run: |
        pip install flet==0.22.1
        pip install openpyxl==3.1.2
        pip install et-xmlfile==1.1.0
        
    - name: ğŸš€ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.0'
        
    - name: ğŸ”¨ Build Flet iOS App
      run: |
        # Ø£ÙˆÙ„Ø§Ù‹: Ø¥Ù†Ø´Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Flet
        flet create "StudentBehaviorApp" --template app
        
        # Ø«Ø§Ù†ÙŠØ§Ù‹: Ù†Ø³Ø® Ù…Ù„ÙØ§ØªÙ†Ø§ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
        cp main.py StudentBehaviorApp/
        cp requirements.txt StudentBehaviorApp/
        
        # Ø«Ø§Ù„Ø«Ø§Ù‹: Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø¬Ù„Ø¯ ÙˆØ§Ù„Ø¨Ù†Ø§Ø¡
        cd StudentBehaviorApp
        
        # Ø±Ø§Ø¨Ø¹Ø§Ù‹: Ø¨Ù†Ø§Ø¡ IPA (Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
        flet build ipa --project "StudentBehavior" --org "com.education"
        
    - name: ğŸ“± Fix iOS Issues
      run: |
        cd StudentBehaviorApp
        
        # Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡
        find . -name "Info.plist" -type f | while read PLIST; do
          # ØªØ¹Ø·ÙŠÙ„ Impeller
          /usr/libexec/PlistBuddy -c "Delete :FLTEnableImpeller" "$PLIST" 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Add :FLTEnableImpeller bool false" "$PLIST"
          
          # Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ©
          /usr/libexec/PlistBuddy -c "Add :CFBundleDevelopmentRegion string 'ar'" "$PLIST" 2>/dev/null || true
          
          echo "âœ… Fixed: $PLIST"
        done
        
    - name: ğŸ“¦ Package IPA
      run: |
        cd StudentBehaviorApp
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† IPA Ø§Ù„Ù…ÙˆÙ„Ø¯
        if [ -f "build/ios/ipa/*.ipa" ]; then
          cp build/ios/ipa/*.ipa ../StudentBehavior.ipa
        else
          # Ø¥Ù†Ø´Ø§Ø¡ IPA ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡
          APP_PATH=$(find . -name "Runner.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            mkdir -p Payload
            cp -r "$APP_PATH" Payload/
            zip -qr ../StudentBehavior.ipa Payload
          fi
        fi
        
    - name: â¬†ï¸ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: iOS-App
        path: |
          StudentBehavior.ipa
          StudentBehaviorApp/build/ios/ipa/*.ipa
        retention-days: 7
